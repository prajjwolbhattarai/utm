<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NAO UTM Builder</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 800px; margin: 2rem auto; padding: 1rem; }
    label, select, input, textarea { display: block; width: 100%; margin-bottom: 1rem; padding: 0.5rem; }
    .output { background: #f4f4f4; padding: 1rem; border-radius: 6px; word-break: break-word; }
    button { padding: 0.7rem; font-weight: bold; cursor: pointer; background: #000; color: #fff; border: none; }
    .warning { color: red; font-size: 0.9rem; }
    datalist option { padding: 0.25rem; }
  </style>
</head>
<body>
  <h1>NAO UTM URL Generator</h1>
  <h4>beta</h4>

  <p>
    <a href="breakdown.html" target="_blank" style="text-decoration: none; font-weight: bold; color: #0073e6;">
      â†’ Go to UTM Breakdown Tool
    </a>
  </p>

  <label>Base URL</label>
  <input type="text" id="baseUrl" placeholder="https://www.investnao.com/your-page" />

  <label>Platform (utm_source)</label>
  <select id="utmSource">
    <!-- options omitted for brevity -->
  </select>

  <label>Traffic Type (utm_medium)</label>
  <select id="utmMedium">
    <!-- options omitted for brevity -->
  </select>

  <!-- Free-form UTM fields -->
  <label>Campaign Name (utm_campaign)</label>
  <input list="campaigns" type="text" id="utmCampaign" placeholder="de_ebook_leads_q3" />
  <datalist id="campaigns"></datalist>
  <div class="warning" id="warn_campaign"></div>

  <label>Creative Version or Test (utm_content)</label>
  <input list="contents" type="text" id="utmContent" placeholder="test_hookline_b_video_v3" />
  <datalist id="contents"></datalist>
  <div class="warning" id="warn_content"></div>

  <label>Search Term or Segment (utm_term, optional)</label>
  <input list="terms" type="text" id="utmTerm" placeholder="investment_guide" />
  <datalist id="terms"></datalist>
  <div class="warning" id="warn_term"></div>

  <label>Ad System ID (utm_id, optional)</label>
  <input list="ids" type="text" id="utmId" placeholder="platform ad ID" />
  <datalist id="ids"></datalist>
  <div class="warning" id="warn_id"></div>

  <label>Language (utm_lang, optional)</label>
  <input list="langs" type="text" id="utmLang" placeholder="de / en" />
  <datalist id="langs"></datalist>
  <div class="warning" id="warn_lang"></div>

  <label>Audience (utm_audience, optional)</label>
  <input list="audiences" type="text" id="utmAudience" placeholder="saver_40plus" />
  <datalist id="audiences"></datalist>
  <div class="warning" id="warn_audience"></div>

  <button onclick="generateUTM()">Generate UTM URL</button>
  <div class="output" id="output"></div>

  <script>
    const SUGGEST_URL = 'https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec';

    function debounce(fn, delay = 300) {
      let timer;
      return (...args) => {
        clearTimeout(timer);
        timer = setTimeout(() => fn(...args), delay);
      };
    }

    function encode(val) {
      return encodeURIComponent(
        val
          .toLowerCase()
          .replace(/[Ã¤Ã¶Ã¼ÃŸ]/g, c => ({ 'Ã¤':'ae','Ã¶':'oe','Ã¼':'ue','ÃŸ':'ss' }[c] || c))
          .replace(/\s+/g, '_')
      );
    }

    async function checkSuggestion(inputEl, type) {
      const val = encode(inputEl.value.trim());
      const warningEl = document.getElementById(`warn_${type}`);
      const datalist = document.getElementById(`${type}s`);
      datalist.innerHTML = '';
      warningEl.innerText = '';

      if (!val) return;

      try {
        const res = await fetch(`${SUGGEST_URL}?action=suggest&type=${type}&query=${val}`);
        if (!res.ok) throw new Error('Network response was not ok');
        const suggestions = await res.json();
        suggestions.forEach(entry => {
          const option = document.createElement('option');
          option.value = entry;
          datalist.appendChild(option);
        });

        if (!suggestions.includes(val)) {
          warningEl.innerText = `${val} is newâ€”will be added when you register.`;
        }
      } catch (err) {
        warningEl.innerText = 'âš ï¸ Suggestion lookup failed';
        console.error(err);
      }
    }

    ['campaign','content','term','id','lang','audience'].forEach(type => {
      const el = document.getElementById('utm' + type.charAt(0).toUpperCase() + type.slice(1));
      el.addEventListener('input', debounce(e => checkSuggestion(e.target, type)));
    });

    function sendToGoogleSheet(data) {
      fetch(SUGGEST_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      })
      .then(res => {
        if (res.ok) alert('âœ… Registered in Google Sheet');
        else alert('âš ï¸ Failed to register.');
      })
      .catch(err => alert('âŒ Error: ' + err));
    }

    function generateUTM() {
      const base = document.getElementById('baseUrl').value.trim();
      if (!base) return alert('Base URL is required');

      const utmSource = encode(document.getElementById('utmSource').value);
      const utmMedium = encode(document.getElementById('utmMedium').value);
      const utmCampaign = encode(document.getElementById('utmCampaign').value);
      const utmContent = encode(document.getElementById('utmContent').value);
      const utmTerm = encode(document.getElementById('utmTerm').value);
      const utmId = encode(document.getElementById('utmId').value);
      const utmLang = encode(document.getElementById('utmLang').value);
      const utmAudience = encode(document.getElementById('utmAudience').value);

      const params = [
        ['utm_source', utmSource],
        ['utm_medium', utmMedium],
        ['utm_campaign', utmCampaign]
      ];
      if (utmContent) params.push(['utm_content', utmContent]);
      if (utmTerm) params.push(['utm_term', utmTerm]);
      if (utmId) params.push(['utm_id', utmId]);
      if (utmLang) params.push(['utm_lang', utmLang]);
      if (utmAudience) params.push(['utm_audience', utmAudience]);

      const queryString = params.map(([k,v]) => `${k}=${v}`).join('&');
      const finalUrl = `${base}?${queryString}`;

      document.getElementById('output').innerHTML = `
        âœ… Generated URL:<br>
        <code>${finalUrl}</code><br><br>
        <button onclick="confirmRegister()">ðŸ“¥ Register this URL in Google Sheet</button>
      `;

      window.latestUTMData = { base, utm_source: utmSource, utm_medium: utmMedium, utm_campaign: utmCampaign,
                                utm_content: utmContent, utm_term: utmTerm, utm_id: utmId,
                                utm_lang: utmLang, utm_audience: utmAudience, final_url: finalUrl };
    }

    function confirmRegister() {
      if (confirm('Do you want to register this URL in the Google Sheet?')) {
        sendToGoogleSheet(window.latestUTMData);
      }
    }
  </script>
</body>
</html>
